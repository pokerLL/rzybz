{% load static %}
{% load template_functions %}
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>{{ book.name }}-{{ book.author }}-ä¹¦è‹‘</title>
    <script src="{% static 'libFront/js/jquery191.min.js' %}"></script>
    <link href="{% static 'libFront/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'libFront/css/font-awesome.min.css' %}" rel="stylesheet">
    <link href="{% static 'libFront/css/window.css' %}" rel="stylesheet">
    <link href="{% static 'libFront/css/site.css' %}" rel="stylesheet">
    <script src="{% static 'libFront/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'libFront/js/dialog.js' %}"></script>
    <script src="{% static 'libFront/js/window.js' %}"></script>
    <script src="{% static 'libFront/js/tools.js' %}"></script>

</head>
<body>

<!-- æ­¤å¤„æ˜¯header -->

{% include 'libFront/headerbar.html' %}

<div class="container body-content">

    <div class="col-md-8">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <ol class="breadcrumb">
            <li><a href="{% url "libfront:index" %}"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li>
            {% if catg %}
                <li><a href="{% url "libfront:category" catg.id 1 %}">{{ catg.name }}</a></li>{% endif %}
            <li class="active">{{ book.name }}</li>
        </ol>
        <!-- ä¹¦ç±ä¿¡æ¯-->
        <div class="panel panel-default">
            <div class="panel-body">
                <div class="row">

                    <div class="col-md-12">
                        <div class="col-md-3">
                            <img src="{% randbookimg book.id %}" style="width: 100%">
                        </div>
                        <div class="col-md-9">
                            <h1 class="bookTitle">{{ book.name }}</h1>
                            <p class="booktag">
                                <a class="red" href="{% url "libfront:search" book.author 1 %}"
                                   target="_blank">{{ book.author }}</a>
                                {% if catg %}
                                    <a class="red" href="{% url "libfront:category" catg.id 1 %}">{{ catg }}</a>
                                {% endif %}
                                <a class="red" target="_blank">åœ¨å€Ÿï¼š{% intdiff book.stock_all book.stock_now %} </a>
                                <a class="red" target="_blank">å‰©ä½™åº“å­˜ï¼š{{ book.stock_now }} </a>
                            </p>
                            <p> ä½œè€…ï¼š<a href="{% url "libfront:search" book.author 1 %}">{{ book.author }}</a></p>
                            <p> å‡ºç‰ˆç¤¾ï¼š<a href="{% url "libfront:search" book.publisher 1 %}">{{ book.publisher }}</a></p>
                            <p> å‡ºç‰ˆæ—¥æœŸï¼š{{ book.pubdate }}</p>
                            <p> å›¾ä¹¦æ ‡ç­¾ï¼š<a href="#"></a>
                            <p class="booktag">
                                {% for it in catgs %}
                                    <a href="{% url "libfront:category" it.id 1 %}">{{ it.name }}</a>
                                {% endfor %}
                            </p>
                            <p> å›¾ä¹¦è¯„åˆ†(å€Ÿé˜…æ•°)ï¼š<a href="{% url "libfront:ranklist" "score" 1 %}">{{ book.score }}/{{ 10 }}
                                ({{ book.borrow_num }})</a>
                            </p>
                            <div class="row">
                                <p class="hidden" id="uid">{{ request.session.user_id }}</p>
                                <p class="hidden" id="bid">{{ book.id }}</p>
                                <span class="col-md-8">
                                        <button class="btn btn-primary" type="button" id="favbook">
                                            <i class="fa fa-thumbs-up fa-fw"></i>ç‚¹èµä¹¦ç±
                                        </button>
										<button class="btn btn-success" type="button" id="borrowbook">
                                            <i class="fa fa-plus fa-fw"></i>å€Ÿé˜…ä¹¦ç±
                                        </button>
                                        <button class="btn btn-info" type="button" id="collectbook">
                                            <i class="fa fa-star fa-fw"></i>æ”¶è—ä¹¦ç±
                                        </button>
                            </span>
                                <div class="clear"></div>
                            </div>
                        </div>


                        <hr>
                    </div>
                    <div class="clear" style="height: 20px"></div>

                    <p class="text-muted" id="bookIntro" style="">
                        ä¹¦ç±ç®€ä»‹ï¼š{{ book.description }}
                    </p>


                </div>
            </div>
        </div>
        <!-- ç« èŠ‚ä¿¡æ¯-->
        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-list fa-fw"></i>
                <strong>ã€Š{{ book.name }}ã€‹å…¨éƒ¨ç« èŠ‚ç›®å½•</strong>
            </div>
            <dl class="panel-body panel-chapterlist">
                {% for i in chapters %}
                    <dd class="col-md-3">ç¬¬{{ forloop.counter }}ç«  {{ i }}</dd>
                {% endfor %}
            </dl>
        </div>
    </div>

    <!-- æäº¤è¯„è®º-->
    <div class="panel panel-default col-md-4">
        <div class="panel-heading">
            <span class="text-muted">
                <i class="fa fa-fire fa-fw"></i><strong>æ’°å†™è¯„è®º</strong>
            </span>
        </div>
        <div class="panel-body">
            <input type="hidden" value="{{ bookid }}" id="book_id">
            <input type="hidden" value="{{ request.session.user_id }}" id="user_id">
            <textarea rows="4" class="form-control" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„è¯„è®º" id="comment_content"></textarea></br>
            <p class="pull-right">
                <button class="btn btn-primary" id="subcmt" type="submit">ğŸ“¤æäº¤è¯„è®º</button>
            </p>
        </div>

        <div class="row">
            <div class="clear"></div>
        </div>
    </div>
    <!-- çƒ­è¯„-->
    <div class="panel panel-default hidden-xs col-md-4">
        <div class="panel-heading"><span class="text-muted"><i class="fa fa-fire fa-fw"></i>çƒ­é—¨è¯„è®º</span></div>
        <div>
            <p class="hidden" id="uid">{{ request.session.user_id }}</p>
            <ul class="list-group list-top">
                {% for i in cms %}
                    <li class="list-group-item">
                        <img class="img-circle" src="{% randprofileimg i.user.id %}" height="30" width="30">
                        <span>{{ i.user.nickname }}</span>&nbsp;&nbsp;
                        <span>{{ i.c_time }}</span>
                        <p class="intro">{{ i.comment }}</p>
                        <p class="hidden cid">{{ i.id }}</p>
                        <p align="right" class="update">
                            <a class="btn cmtlike">
                                <i class="fa {% cmtlikebtn i.id userid %} fa-fw"></i>
                            </a>
                            <span class="pnum">{{ i.p_num }}</span>

                        </p>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- åº•éƒ¨æ¨è-->
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading"><span class="text-muted"><i class="fa fa-fire fa-fw"></i>åŒç±»å›¾ä¹¦æ¨è</span></div>
            <div class="panel-body panel-friendlink">
                {% for i in rmds %}
                    <a href="{% url "libfront:bookdetail" i.id %}">{{ i.name }}</a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<div class="hidden" id="myform">
    <form action="#" method="#" id="borrowform">
        {% csrf_token %}
        <div class="form-group">
            <label for="user" class="col-sm-4 control-label">å½“å‰ç”¨æˆ·ï¼š</label>
            <input disabled="true" value="{{ request.session.nickname }}" name="user">
        </div>
        <div class="form-group">
            <label for="name" class="col-sm-4 control-label">ä¹¦åï¼š</label>
            <input disabled="true" value="{{ book.name }}" name="name">
        </div>
        <div class="form-group">
            <label for="author" class="col-sm-4 control-label">ä½œè€…ï¼š</label>
            <input disabled="true" value="{{ book.author }}" name="author">
        </div>
        <div class="form-group">
            <label for="pubdate" class="col-sm-4 control-label">å‡ºç‰ˆæ—¥æœŸï¼š</label>
            <input disabled="true" value="{{ book.pubdate | date:"Y-m-d" }}" name="pubdate">
        </div>
        <div class="form-group">
            <label for="publisher" class="col-sm-4 control-label">å‡ºç‰ˆç¤¾ï¼š</label>
            <input disabled="true" value="{{ book.publisher }}" name="publisher">
        </div>
        <div class="form-group">
            <label for="score" class="col-sm-4 control-label">è¯„åˆ†ï¼š</label>
            <input disabled="true" value="{{ book.score }}/10" name="score">
        </div>
        <div class="form-group">
            <label class="col-sm-4 control-label">å½“å‰åº“å­˜/æ€»åº“å­˜ï¼š</label>
            <input disabled="true" value="{{ book.stock_now }} / {{ book.stock_all }}">
        </div>
        <div class="form-group">
            <label class="col-sm-4 control-label">å†å²å€Ÿé˜…æ•°ï¼š</label>
            <input disabled="true" value="{{ book.borrow_num }}">
        </div>
        <div class="form-group">
            <label class="col-sm-4 control-label">è¿˜ä¹¦æ—¥æœŸï¼š</label>
            <input type="date" name="endtime" id="endtime" value="1900-01-01">
            <script>
                var date = new Date();
                var str = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
                if (date.getDate() < 10) {
                    str = date.getFullYear() + "-" + (date.getMonth() + 1) + "-0" + date.getDate();
                }
                console.log(str);
                $("#endtime").attr("value", str);
            </script>
        </div>
        <input class="hidden" name="book_id" value="{{ book.id }}">
        <input class="hidden" name="user_id" value="{{ request.session.user_id }}">
        {#        <div class="form-group">#}
        {#            <label class="col-sm-4 control-label">å€Ÿé˜…æ—¶é•¿ï¼š</label>#}
        {#            <select name="duration">#}
        {#                <option value="1">1 å¤©</option>#}
        {#                <option value="3">3 å¤©</option>#}
        {#                <option value="7">7 å¤©</option>#}
        {#                <option value="15">15å¤©</option>#}
        {#                <option value="30">30å¤©</option>#}
        {#            </select>#}
        {#        </div>#}

    </form>
</div>
<span style="display:none">
    <script>

        function submitBorrow() {
            console.log("hi");
            $.ajax({
                url: "{% url "libfront:borrow" %}",
                method: "POST",
                data: $('#borrowform').serialize(),
                success: function (data) {
                    //console.log(data);//æ‰“å°æœåŠ¡ç«¯è¿”å›çš„æ•°æ®(è°ƒè¯•ç”¨)
                    var code = data["code"];
                    if (code === 500) {
                        alert("å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•å†è¿›è¡Œæ“ä½œã€‚")
                    } else if (code === 200) {
                        alert("å€Ÿé˜…æˆåŠŸï¼Œå¿«å»çœ‹çœ‹å§ï¼Œè®°å¾—åŠæ—¶è¿˜ä¹¦å–”ã€‚");
                        $(".closebtn").click();
                    } else if (code === 401) {
                        alert("ä¹¦ç±åº“å­˜ä¸è¶³ï¼Œå€Ÿé˜…å¤±è´¥ï¼Œä¸‹æ¬¡æ—©ç‚¹æ¥å§ã€‚")
                    } else if (code === 400) {
                        alert("å‘ç”Ÿé”™è¯¯ï¼Œå€Ÿé˜…å¤±è´¥ï¼")
                    }
                },
                error: function () {
                    alert("å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œæ“ä½œå¤±è´¥ï¼");
                }
            });
        }
    </script>
    <script>
		$(document).ready(function (e) {
            $("#borrowbook").click(function () {
                var html = $("#myform").html();
                {#$("#myform").html("nothing");#}
                {#console.log(html);#}
                var button = "<p align='right'>" +
                    "<input class='btn btn-primary' type='button' value='é‡ç½®' />&nbsp&nbsp" +
                    "<input class='btn btn-primary' type='button' value='ç¡®å®š' onclick='submitBorrow()'/>&nbsp&nbsp" +
                    "<input class='btn btn-primary closebtn' type='button' value='å–æ¶ˆ' />" +
                    "</p>";

                var win = new Window({
                    width: 500, //å®½åº¦
                    height: 600, //é«˜åº¦
                    title: '{{ book.name }}-å€Ÿé˜…', //æ ‡é¢˜
                    content: html, //å†…å®¹
                    isMask: true, //æ˜¯å¦é®ç½©
                    buttons: button, //æŒ‰é’®
                    isDrag: true, //æ˜¯å¦ç§»åŠ¨
                });
            })
        });
	</script>
</span>

{% include "libFront/footerbar.html" %}
</body>
</html>
